<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layouts/default">

<th:block layout:fragment="head">
    <title>HONG SHOP</title>
    <style>
        .ck-editor__editable { height: 200px; }
        .ck-content { font-size: 12px; }
    </style>
</th:block>

<th:block layout:fragment="content">
    <div class="container-sm mt-3">
        <div class="card-header" style="margin-bottom: 10px">
            <div class="card-text d-flex justify-content-between">
                <div class="text-start">
                    <h3 th:text="|${type.postName}|"></h3>
                </div>
                <div class="text-end">
                    <button type="button" class="btn btn-info" id="list-btn">목록</button>
                    <button type="button" class="btn btn-secondary" id="save-btn">저장</button>
                </div>
            </div>
        </div>
        <div class="card-body">

            <div class="mb-3 mt-3" style="margin-bottom: 10px;">
                <label for="title">제목</label>
                <input type="text" class="form-control" id="title" name="title" th:value="${post.title}"/>
            </div>

            <hr class="hr" />

            <div class="mb-3 mt-3" style="margin-bottom: 10px;">
                <label for="content">내용</label>
                <div id="content" name="content" class="ckeditor" style="min-height: 300px"></div>
            </div>

            <hr class="hr" />

            <div class="mb-3 mt-3">
                <label for="file-container">파일첨부</label>
                <input type="file" id="fileUpload" name="file" style="display:none"/>
                <button class="btn btn-sm btn-primary" id="btn-upload">
                    파일 추가
                    <i data-feather="upload" class="font-medium-2 ms-50"></i>
                </button>
                <div class="file-container" id="file-container">
                    <ul id="upload-container"></ul>
                </div>
            </div>

        </div>
    </div>
</th:block>


<th:block layout:fragment="script">
    <script th:inline="javascript">

        const post = /*[[${post}]]*/ {}
        console.log("post : ", post)
        let fileGroupId = null;
        if(post['file']) fileGroupId = post['file'].id
        let deleteFile = []

        $(document).ready(function(){
            if(post['file']) setFileList(post['file']['fileList']);

            $("#list-btn").on("click", function(e){
                const result = confirm("수정 정보가 저장되지 않을수도 있습니다." + '\n' + "목록으로 돌아가시겠습니까?")
                if(result) {
                    window.location.href = `/bbs/${post['typeId']}`
                }
            })

            $("#save-btn").on("click", function(e){
                console.log("clicked")
                console.log("deleteFile : ", deleteFile)
                console.log("content : ", ckEditor.getData())
                console.log("title : ", $("#title").val())
                console.log("fileGroupId : ", fileGroupId)
                // window.location.href = ``

                if(ckEditor.getData().length === 0) alert("내용을 입력해주세요.")
                else {
                    const obj = {
                        'title' : $("#title").val(),
                        'content': ckEditor.getData(),
                        'hongPostTypeId' : post['typeId'],
                        'deleteFile': deleteFile
                    }

                    if(fileGroupId !== null) obj['fileGroupId'] = fileGroupId

                    $.ajax({
                        type: "PUT",
                        url: `/api/post/${post['id']}`,
                        data: JSON.stringify(obj),
                        contentType: "application/json",
                        success: function(response) {
                            if(response.httpStatus === 200){
                                alert("수정되었습니다.")
                                window.location.href = `/bbs/${post['typeId']}`
                            }
                        },
                        error: function(error) {
                            console.error("File upload error:", error);
                        }
                    });
                }
            })

            $('#btn-upload').on("click", function (e) {
                e.preventDefault();
                $('#fileUpload').click();
            });

            $("#fileUpload").on("change", function (e) {
                const selectedFile = e.target.files[0];
                const fileName = selectedFile.name

                const formData = new FormData();
                formData.append("file", selectedFile);
                if(fileGroupId) formData.append("fileGroupId", fileGroupId);

                $.ajax({
                    type: "POST",
                    url: "/api/uploadFile",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        if(response.httpStatus === 200) {
                            fileGroupId = response.message.fileGroupId
                            addFileList({'originalFileName': fileName, 'id': response.message.id})
                        }
                    },
                    error: function(error) {
                        // Handle the error response
                        console.error("File upload error:", error);
                    }
                });
            });
        })

        const setFileList = (file = []) => {
            const dom = $("#upload-container")
            dom.empty()

            file.forEach((value, i) => {
                const body =
                    `
                    <li style="margin-top: 10px;" data-file-id="${value.id}">
                        <a href="#" onclick="trashFile(${value.id})">
                            <i data-feather="trash" class="front-medium-2"></i>
                        </a>
                        ${value['originalFileName']}
                    </li>
                    `
                dom.append(body)
            });
            feather.replace()
        }

        const addFileList = (file = []) => {
            const dom = $("#upload-container")
            const body =
                `
                <li style="margin-top: 10px;" data-file-id="${file.id}">
                    <a href="#" onclick="trashFile(${file.id})">
                        <i data-feather="trash" class="front-medium-2"></i>
                    </a>
                    [임시저장] ${file['originalFileName']}
                </li>
                `
            dom.append(body)
            feather.replace()
        }

        function trashFile(id){
            deleteFile.push(id)
            const listItem = $(`[data-file-id="${id}"]`);
            listItem.remove();
        }


        let ckEditor;
        ClassicEditor
            .create( document.querySelector( '#content' ), {
                extraPlugins: [MyCustomUploadAdapterPlugin]
            } )
            .then( editor => {
                ckEditor = editor;
                ckEditor.setData([[${post['content']}]])
            } )
            .catch( error => {
            } );

        function MyCustomUploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
                return new MyUploadAdapter(loader)
            }
        }

    </script>
</th:block>

</html>