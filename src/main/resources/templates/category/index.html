<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">

<th:block layout:fragment="head">
    <title>HONG SHOP</title>
    <style>
        .nav-link {
            margin-top: 10px; /* Adjust the margin-top value as needed */
        }
    </style>
</th:block>

<th:block layout:fragment="content">
    <div class="mt-3">
        <div class="card-header" style="margin-bottom: 10px">
            <div class="card-text d-flex justify-content-between">
                <div class="text-start">
                    <h3 id="category-name">ìµœì‹ ìƒí’ˆ</h3>
                </div>
                <div class="text-end"></div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <!-- Vertical tabs -->
                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <a class="nav-link active nav-category-link" id="newProdcuts-tab" data-bs-toggle="tab" href="#newProdcuts" role="tab" aria-controls="newProdcuts" aria-selected="true">ìµœì‹ ìƒí’ˆ</a>
                        <a th:each="cat, catStaa: ${categories}" class="nav-link nav-category-link"  data-bs-toggle="tab" role="tab" aria-selected="false" th:id="|product-${cat.categoryId}-tab|" th:href="'#product'+${cat.categoryId}" th:aria-controls="|product${cat.categoryId}|" th:text="${cat.categoryName}"></a>
                    </div>
                </div>
                <div class="col-md-9">
                    <!-- Tab content -->
                    <div class="tab-content" id="tab-content">

                        <!-- s: newProdcuts-tab -->
                        <div class="tab-pane fade show active" id="newProdcuts" role="tabpanel" aria-labelledby="newProdcuts-tab">
                            <div class="image-grid">
                                <div class="image-item" th:each="product, productStat : ${newProdcuts}">
                                    <button class="btn img-btn" type="button" th:id="|btn-${product.productId}|" th:data-num="${product.productId}" th:data-stock="${product.productStock}">
                                        <img th:src="${(product.getFile() != null and product.getFile().getFileList().size() >= 1) ? '/image?imageId=' + product.getFile().getFileList().get(0).getSavedFileName() : '/assets/src/shop/noImage.png'}"
                                             th:id="|img-${product.productId}|" class="rounded" alt="Image" style="width: 150px; height: 150px">
                                    </button>
                                    <div class="product-info">
                                        <p class="image-name">
                                            <span th:text="${product.productName}" th:id="|name-${product.productId}|"></span>
                                            <i data-feather="star" class="font-medium-2 ms-50"></i>
                                        </p>
                                        <p th:text="|ê°€ê²©: ${#numbers.formatInteger(product.productPrice, 0, 'COMMA')} ì›|" class="image-name" th:id="|price-${product.productId}|" th:data-price="${product.productPrice}"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- e: newProdcuts-tab -->

                        <th:block th:each="cat, catStat : ${categories}">
                            <!-- s: product-tab -->
                            <div class="tab-pane fade" th:id="|product${cat.categoryId}|" role="tabpanel" th:aria-labelledby="|product-${cat.categoryId}-tab|">

                                <!-- s: empty card -->
                                <div class="card" id="empty-div" th:if="${cat.productList.size() == 0}">
                                    <div class="card-body" style="text-align: center">
                                        <h4>ìƒí’ˆì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</h4>
                                    </div>
                                </div>
                                <!-- e: empty card -->


                                <div class="image-grid" th:unless="${cat.productList.size() == 0}">
                                    <div class="image-item" th:each="product, productStat : ${cat.productList}">
                                        <button class="btn img-btn" type="button" th:id="|btn-${product.productId}|" th:data-num="${product.productId}" th:data-stock="${product.productStock}">
                                            <img th:src="${(product.getFile() != null and product.getFile().getFileList().size() >= 1) ? '/image?imageId=' + product.getFile().getFileList().get(0).getSavedFileName() : '/assets/src/shop/noImage.png'}"
                                                 th:id="|img-${product.productId}|"
                                                 class="rounded"
                                                 alt="Image"
                                                 style="width: 150px; height: 150px">
                                        </button>
                                        <div class="product-info">
                                            <p th:if="${product.productStock == 0}" class="image-name" style="color: red; font-size: 15px">í•´ë‹¹ ìƒí’ˆì€ í˜„ì¬ ì¬ê³ ê°€ ì—†ì–´ì„œ ì£¼ë¬¸ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                                            <p class="image-name">
                                                <span th:text="${product.productName}" th:id="|name-${product.productId}|"></span>
                                                <i th:if="${product.newProductYn == 'Y'}" data-feather="star" class="font-medium-2 ms-50"></i>
                                            </p>
                                            <p th:text="|ê°€ê²©: ${#numbers.formatInteger(product.productPrice, 0, 'COMMA')} ì›|" class="image-name" th:id="|price-${product.productId}|" th:data-price="${product.productPrice}"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- e: product-tab -->
                        </th:block>

                    </div>
                </div>
            </div>
        </div>

        <!-- s: Alert Modal -->
        <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="card-body">
                            <p>í•´ë‹¹ ìƒí’ˆì€ í˜„ì¬ ì¬ê³ ê°€ ì—†ì–´ì„œ êµ¬ì…ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                            <p>í•´ë‹¹ ë¬¼í’ˆ êµ¬ì…ì„ ì›í•˜ì‹ ë‹¤ë©´ ë¬¸ì˜ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
                            <div style="margin-top: 10px" class="text-end">
                                <button type="button" class="btn btn-outline-secondary" id="close-alertModal">ë‹«ê¸°</button>
                                <button type="button" class="btn btn-outline-primary" id="goto-qna-post">ë¬¸ì˜ê¸€ ì‘ì„±í•˜ëŸ¬ê°€ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- e: Alert Modal -->

        <!-- s: Product Purchase Modal -->
        <form id="product-purchase-form" class="needs-validation" novalidate>
            <div class="modal fade" id="product-purchase-modal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <!-- Modal Header -->
                        <div class="modal-header">
                            <h4 class="modal-title">ì£¼ë¬¸í•˜ê¸°</h4>
                            <button type="button" class="btn-close" id="close-product-purchase-modal-btn"></button>
                        </div>

                        <div class="modal-body">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 col-12" style="margin-bottom: 10px; align-content: center">
                                        <div class="product-container">
                                            <img src="/assets/src/shop/noImage.png" class="rounded" alt="Image" style="width: 150px; height: 150px" id="product-img">
                                            <div class="product-name" id="product-name"></div>
                                            <div class="product-price" id="product-price"></div>
                                            <div class="product-stock" id="product-stock"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-12 col-12">
                                        <div class="mb-1">
                                            <input type="hidden" name="hongProductId" id="hongProductId" />
                                            <label class="form-label" for="product-order-num">ì£¼ë¬¸ ê°œìˆ˜<span class="text-primary ms-50">*</span></label>
                                            <div class="input_wrap">
                                                <input type="number" class="form-control" id="product-order-num" name="product-order-num" min="1" required/>
                                                <div class="invalid-feedback" id="product-invalid-feedback">ì£¼ë¬¸ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 10px" class="text-end">
                                    <button type="button" class="btn btn-outline-secondary" id="close-productModal">ë‹«ê¸°</button>
                                    <button type="submit" class="btn btn-outline-primary" id="into-purchase">ğŸì£¼ë¬¸í•˜ê¸°</button>
                                    <button type="submit" class="btn btn-outline-success" id="into-cart">ğŸ›’ì¥ë°”êµ¬ë‹ˆë‹´ê¸°</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <!-- e: Product Purchase Modal -->
    </div>
</th:block>


<th:block layout:fragment="script">
    <script th:inline="javascript">
        const newProdcuts = /*[[${newProdcuts}]]*/[]
        const categories = /*[[${categories}]]*/{}
        const qnaPost = /*[[${qnaPost}]]*/{}

        $(document).ready(function(e){
            feather.replace()
        })

        /* ì¹´í…Œê³ ë¦¬ nav í´ë¦­ì— ë”°ë¥¸ text ë³€ê²½ */
        $(".nav-category-link").on("click", function(e){
            const categoryName = $(this).text();
            $("#category-name").text(categoryName)
        })

        /* ìƒí’ˆêµ¬ë§¤ ëª¨ë‹¬ì°½ ë‹«ê¸° */
        $("#close-productModal, #close-product-purchase-modal-btn").on("click", function(e){
            $("#product-order-num").val('')
            const form = document.getElementById("product-purchase-form")
            form.classList.remove("was-validated")      // validation ì§€ìš°ê¸°
            $("#product-purchase-modal").modal('hide')
        })

        /* ìƒí’ˆêµ¬ë§¤ ëª¨ë‹¬ì°½ ë‹«íë•Œ -> validation ì´ˆê¸°í™” ë° ì£¼ë¬¸ê°œìˆ˜ ì´ˆê¸°í™” */
        $("#product-purchase-modal").on('hidden.bs.modal', function (e) {
            $("#product-order-num").val('')
            const form = document.getElementById("product-purchase-form")
            form.classList.remove("was-validated")      // validation ì§€ìš°ê¸°
        });

        /* alertModal ëª¨ë‹¬ì°½ ë‹«ê¸° */
        $("#close-alertModal").on("click", function(e){
            $("#alertModal").modal('hide')
        })

        /* alertModal -> [ë¬¸ì˜ê¸€ ì‘ì„±í•˜ëŸ¬ê°€ê¸°] ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ */
        $("#goto-qna-post").on("click", function(e){
            if(qnaPost) window.location.href = `/bbs/${qnaPost['postTypeId']}`
            else {
                Util.alert(`ì£„ì†¡í•©ë‹ˆë‹¤. <br /> ì•„ì§ ì§ˆì˜ì‘ë‹µ ê²Œì‹œíŒì´ ì—†ìŠµë‹ˆë‹¤. <br /> ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`).then(() => {
                    $("#alertModal").modal('hide')
                })
            }
        })

        /* ì´ë¯¸ì§€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ */
        $(".img-btn").on("click", function(e){
            const productId = $(this).attr("data-num")
            const productStock = $(this).attr("data-stock")
            const productName = $(`#name-${productId}`).text()
            const productImg = $(`#img-${productId}`).attr('src')
            const productPrice = $(`#price-${productId}`).attr('data-price')

            if(productStock == 0) $("#alertModal").modal('show')
            else {
                const price = Util.priceString(productPrice)
                $("#hongProductId").val(productId)
                $("#product-name").text(productName)                            // ìƒí’ˆ ì´ë¦„
                $("#product-price").text(`ê°€ê²©: ${price} ì›`)                    // ìƒí’ˆ ê°€ê²©
                $("#product-stock").text(`ì¬ê³ : ${productStock} ê°œ`)             // ìƒí’ˆ ì¬ê³ 
                $("#product-img").attr("src", productImg)                       // ìƒí’ˆ ì´ë¯¸ì§€

                $("#product-order-num").attr('max', productStock)                                   // ìƒí’ˆ ìµœëŒ€ ì£¼ë¬¸ ê°œìˆ˜
                $("#product-invalid-feedback").text(`ìµœëŒ€ ì£¼ë¬¸ê°€ëŠ¥ ê°œìˆ˜ëŠ” ${productStock}ê°œ ì…ë‹ˆë‹¤.`)    // ìƒí’ˆ ì£¼ë¬¸ form -> validation text
                $("#product-purchase-modal").modal('show')
            }
        })

        /* ìƒí’ˆ êµ¬ë§¤í•˜ê¸° form */
        window.addEventListener("load", function() {
            const form = document.getElementById("product-purchase-form")
            form.addEventListener("submit", function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    form.classList.add("was-validated")
                } else {
                    event.preventDefault();

                    FormDataToObj.getParameter("product-purchase-form").then((obj) => {

                        const submitButtonId = event.submitter.id;

                        // ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                        if(submitButtonId === 'into-cart') {
                            Util.confirm("í•´ë‹¹ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ë‹´ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?").then((isOk) => {
                                if(isOk) {
                                    $.ajax({
                                        type: 'GET',
                                        url: `/api/find-cart/${obj['hongProductId']}`,
                                        dataType: 'json',
                                        contentType: 'application/json',
                                        success: function (data) {
                                            if(data.httpStatus === 200) {
                                                if(!data.message) Util.alert(`ì´ë¯¸ í•´ë‹¹ ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ìˆìŠµë‹ˆë‹¤. <br/> í™•ì¸í•´ì£¼ì„¸ìš”.`, 'w', 'w')
                                                else {
                                                    const OBJ = {'hongProductId': obj['hongProductId'], 'cartCnt': obj['product-order-num']}
                                                    $.ajax({
                                                        type: 'POST',
                                                        url: `/api/cart`,
                                                        dataType: 'json',
                                                        data: JSON.stringify(OBJ),
                                                        contentType: 'application/json',
                                                        success: function (data) {
                                                            if (data.httpStatus === 200) {
                                                                Util.confirm(`í•´ë‹¹ ë¬¼í’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤. <br/> ì¥ë°”êµ¬ë‹ˆë¥¼ ë³´ëŸ¬ê°€ì‹œê² ìŠµë‹ˆê¹Œ?`).then((isOk) => {
                                                                    if (isOk) window.location.href = '/user/cart'
                                                                    else $("#product-purchase-modal").modal('hide')
                                                                })
                                                            } else {
                                                                Util.alert("í•´ë‹¹ ë¬¼í’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", 'w', 'w')
                                                            }
                                                        },
                                                        error: function (xhr, status, error) {
                                                            console.error('Error getting password:', error);
                                                        }
                                                    });
                                                }
                                            }
                                        },
                                        error: function (xhr, status, error) {
                                            console.error('Error getting password:', error);
                                        }
                                    });
                                }
                            })
                        } else if(submitButtonId === 'into-purchase') {
                            // êµ¬ë§¤í•˜ê¸°
                            Util.confirm("í•´ë‹¹ìƒí’ˆì„ êµ¬ì…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?").then((isOk) => {
                                if(isOk) window.location.href = `/order/shop?productId=${obj['hongProductId']}&orderNum=${obj['product-order-num']}`
                            })
                        }
                    })
                }
            })
        })
    </script>
</th:block>

</html>